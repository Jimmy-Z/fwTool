

@---------------------------------------------------------------------------------
@ http://problemkaputt.de/gbatek.htm#dsmemorycontrolbios
@---------------------------------------------------------------------------------
@ 0x000005EC :  ldrb r3,[r3,12h]      ;requires incoming r3=src-12h
@ 0x000005EE :  pop  r2,r4,r6,r7,r15  ;requires dummy values & THUMB retadr on stack
@---------------------------------------------------------------------------------
@ after dumping found a better instruction sequence
@ Unfortunately this one only works on DSi in DS mode.
@---------------------------------------------------------------------------------
@ 0x00001664 : ldr r1, [r1] ; str r1, [r0] ; bx lr
@---------------------------------------------------------------------------------
@ We need code in the BIOS below 0x00001204 to dump protected area on DS/DS Lite
@---------------------------------------------------------------------------------
	.arch	armv4t
	.cpu	arm7tdmi

	.text

	.arm

@---------------------------------------------------------------------------------
call_5ec:
@---------------------------------------------------------------------------------
	adr 	r2, thumb_ret + 1
	push	{r2}
	push	{r2, r4, r6, r7}
	ldr 	r2, =0x5ed
	bx	r2

	.thumb

thumb_ret:
	bx	lr

	.global readBios
@---------------------------------------------------------------------------------
	.arm
	.align	4
	.type	readBios STT_FUNC
@---------------------------------------------------------------------------------
readBios:
@---------------------------------------------------------------------------------
	push	{lr}
	mov	r1, #0
	mov	r11, r11
readLoop:
	mov	r3, r1
	sub	r3, #18
	bl	call_5ec
	strb	r3, [r0]
	add	r0, r0, #1
	add	r1, r1, #1
	cmp	r1, #0x4000
	bne	readLoop

	pop	{lr}
	bx	lr

	.global readDSiBios
@---------------------------------------------------------------------------------
	.arm
	.align	4
	.type	readDSiBios STT_FUNC
@---------------------------------------------------------------------------------
readDSiBios:
@---------------------------------------------------------------------------------
	mov	r2,#0x10000
	mov	r1,#0x0
	ldr	r3, =0x6bb0
	bx	r3

	.pool

